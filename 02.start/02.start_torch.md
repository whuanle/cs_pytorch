# 开始使用 Torch

创建一个控制台项目，引入 ：

```
TorchSharp
TorchSharp-cuda-windows
TorchVision
Maomi.Torch
Maomi.ScottPlot.Winforms
```



TorchVision 是一个工具集，可以从 Fashion-MNIST 下载数据集以及进行一些数据类型转换等功能。

我们使用以下参数加载 [FashionMNIST 数据集](https://pytorch.ac.cn/vision/stable/datasets.html#fashion-mnist)

- `root` 是存放训练/测试数据的路径。
- `train` 指定训练或测试数据集。
- `download=True` 如果 `root` 中没有数据，则从互联网下载数据。
- `transform` 和 `target_transform` 指定特征和标签转换。

```csharp
using TorchSharp;
using static TorchSharp.torch;
using datasets = TorchSharp.torchvision.datasets;
using transforms = TorchSharp.torchvision.transforms;


// 指定训练数据集
var training_data = datasets.FashionMNIST(
    root: "data",   // 数据集在那个目录下
    train: true,    // 加载该数据集，用于训练
    download: true, // 如果数据集不存在，是否下载
    target_transform: transforms.ConvertImageDtype(ScalarType.Float32) // 指定特征和标签转换，将标签转换为Float32
    );

// 指定测试数据集
var test_data = datasets.FashionMNIST(
    root: "data",   // 数据集在那个目录下
    train: false,    // 加载该数据集，用于训练
    download: true, // 如果数据集不存在，是否下载
    target_transform: transforms.ConvertImageDtype(ScalarType.Float32) // 指定特征和标签转换，将标签转换为Float32
    );
```



注意，Pytorch 官方给出了 `ToTensor()` 函数用于标签转换，但是由于 C# 版本并没有这个函数，因此只能手动指定一个转换器。



启动项目，耐心等待下载完成，在下面运行目录下会自动创建一个 data 目录，里面是数据集文件。。

![image-20241202120839339](images/image-20241202120839339.png)



数据集是 Dataset 类型，本身继承了 `Dataset<Dictionary<string, Tensor>>` 类型，其本身是一个字典集合。

里面是个列表，每个元素都是一个字典，每个字典由 data、label两个 key 组成。

```

for (int i = 0; i < training_data.Count; i++)
{
    var dic = training_data.GetTensor(i);
    var img = dic["data"];
    var label = dic["label"];
}

```



由于数据集有 6 万张图片，一次性加载比较消耗下，因此我们需要分批处理：

```csharp
// 分批加载图像，打乱顺序
var train_loader = torch.utils.data.DataLoader(training_data, batchSize: 100, shuffle: true);
// 分批加载图像，不打乱顺序
var test_loader = torch.utils.data.DataLoader(test_data, batchSize: 100, shuffle: false);
```



分批之后遍历：

```csharp
foreach (var item in train_loader)
{
    var images = item["data"];
    var lables = item["label"];
}

```

